<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Public health surveillance with surveil • surveil</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/sandstone/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Public health surveillance with surveil">
<meta property="og:description" content="surveil">
<meta property="og:image" content="https://connordonegan.github.io/surveil/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-116873024-1"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-116873024-1');
</script>
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">surveil</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/demonstration.html">Public health surveillance with surveil</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/ConnorDonegan/surveil/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Public health surveillance with surveil</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/ConnorDonegan/surveil/blob/master/vignettes/demonstration.Rmd" class="external-link"><code>vignettes/demonstration.Rmd</code></a></small>
      <div class="hidden name"><code>demonstration.Rmd</code></div>

    </div>

    
    
<p>This vignette demonstrates basic usage of <strong>surveil</strong> for public health surveillance. <strong>surveil</strong> leverages the principles of Bayesian inference <span class="citation">(Jaynes <a href="#ref-jaynes_2003">2003</a>; MacKay <a href="#ref-mackay_2003">2003</a>)</span> to infer population risk of disease or death given time series data consisting of case counts and population at risk. Models were built using the <a href="https://mc-stan.org/" class="external-link">Stan</a> modeling language, but users only need to be familiar with the R language.</p>
<p>The package also contains special methods for age-standardization, printing and plotting model results, and for measuring and visualizing health inequalities.</p>
<div id="getting-started" class="section level2">
<h2 class="hasAnchor">
<a href="#getting-started" class="anchor" aria-hidden="true"></a>Getting started</h2>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## packages required for the analysis</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://connordonegan.github.io/surveil/">surveil</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span>
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme_get.html" class="external-link">theme_set</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_classic</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>
<span class="co">## for the vignette</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://yihui.org/knitr/" class="external-link">knitr</a></span><span class="op">)</span></code></pre></div>
<p>Surveillance data minimally contain case counts, reliable population at risk estimates, and a discrete time period variable. They also may include one or more grouping variables, such as race-ethnicity.</p>
<p>This vignette analyzes age-specific (ages 50-79) colorectal cancer incidence data by race-ethnicity, year, and Texas MSA, obtained through CDC Wonder. The race-ethnicity grouping includes (non-Hispanic) Black, (non-Hispanic) White, and Hispanic, and the MSAs include those centered on the cities of Austin, Dallas, Houston, and San Antonio.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">msa</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
  <span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span>booktabs <span class="op">=</span> <span class="cn">TRUE</span>, 
        caption <span class="op">=</span> <span class="st">"Glimpse of colorectal cancer incidence data (CDC Wonder)"</span><span class="op">)</span> </code></pre></div>
<table class="table">
<caption>Glimpse of colorectal cancer incidence data (CDC Wonder)</caption>
<thead><tr class="header">
<th align="right">Year</th>
<th align="left">Race</th>
<th align="left">MSA</th>
<th align="right">Count</th>
<th align="right">Population</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="right">1999</td>
<td align="left">Black or African American</td>
<td align="left">Austin-Round Rock, TX</td>
<td align="right">28</td>
<td align="right">14421</td>
</tr>
<tr class="even">
<td align="right">2000</td>
<td align="left">Black or African American</td>
<td align="left">Austin-Round Rock, TX</td>
<td align="right">16</td>
<td align="right">15215</td>
</tr>
<tr class="odd">
<td align="right">2001</td>
<td align="left">Black or African American</td>
<td align="left">Austin-Round Rock, TX</td>
<td align="right">22</td>
<td align="right">16000</td>
</tr>
<tr class="even">
<td align="right">2002</td>
<td align="left">Black or African American</td>
<td align="left">Austin-Round Rock, TX</td>
<td align="right">24</td>
<td align="right">16694</td>
</tr>
<tr class="odd">
<td align="right">2003</td>
<td align="left">Black or African American</td>
<td align="left">Austin-Round Rock, TX</td>
<td align="right">34</td>
<td align="right">17513</td>
</tr>
<tr class="even">
<td align="right">2004</td>
<td align="left">Black or African American</td>
<td align="left">Austin-Round Rock, TX</td>
<td align="right">26</td>
<td align="right">18429</td>
</tr>
</tbody>
</table>
<p><strong>surveil</strong>’s model fitting function, <code>stan_rw</code>, requires that the user provide a <code>data.frame</code> with specific column names. There must be one column named <code>Cases</code> containing case counts, and another column named <code>Population</code>, containing the sizes of the populations at risk. The user also must provide the name of the column containing the time period, and, optionally, a grouping factor. For the MSA data printed above, the grouping column is Race and the time column is Year.</p>
</div>
<div id="preparing-the-data" class="section level2">
<h2 class="hasAnchor">
<a href="#preparing-the-data" class="anchor" aria-hidden="true"></a>Preparing the data</h2>
<p>We will first analyze aggregated CRC cases across Texas’s top four MSAs. The <code>msa</code> data from CDC Wonder already has the necessary format (column names and contents), but the data are dis-aggregated by MSA. So for this analysis, we first group the data by year and race, and then combine cases across MSAs.</p>
<p>The following code chunk aggregates the data using the <code>dplyr</code> package:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">tx.msa</span> <span class="op">&lt;-</span> <span class="va">msa</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">Year</span>, <span class="va">Race</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>Count <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">Count</span><span class="op">)</span>,
            Population <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">Population</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>The following code provides a glimpse of the aggregated data (Table 2):</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">tx.msa</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
  <span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span>booktabs <span class="op">=</span> <span class="cn">TRUE</span>, 
        caption <span class="op">=</span> <span class="st">"Glimpse of aggregated Texas metropolitan CRC cases, by race and year"</span><span class="op">)</span></code></pre></div>
<table class="table">
<caption>Glimpse of aggregated Texas metropolitan CRC cases, by race and year</caption>
<thead><tr class="header">
<th align="right">Year</th>
<th align="left">Race</th>
<th align="right">Count</th>
<th align="right">Population</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="right">1999</td>
<td align="left">Black or African American</td>
<td align="right">471</td>
<td align="right">270430</td>
</tr>
<tr class="even">
<td align="right">1999</td>
<td align="left">Hispanic</td>
<td align="right">361</td>
<td align="right">377471</td>
</tr>
<tr class="odd">
<td align="right">1999</td>
<td align="left">White</td>
<td align="right">2231</td>
<td align="right">1654251</td>
</tr>
<tr class="even">
<td align="right">2000</td>
<td align="left">Black or African American</td>
<td align="right">455</td>
<td align="right">283280</td>
</tr>
<tr class="odd">
<td align="right">2000</td>
<td align="left">Hispanic</td>
<td align="right">460</td>
<td align="right">405562</td>
</tr>
<tr class="even">
<td align="right">2000</td>
<td align="left">White</td>
<td align="right">2343</td>
<td align="right">1704425</td>
</tr>
</tbody>
</table>
</div>
<div id="model-specification" class="section level2">
<h2 class="hasAnchor">
<a href="#model-specification" class="anchor" aria-hidden="true"></a>Model specification</h2>
<div id="the-basics" class="section level3">
<h3 class="hasAnchor">
<a href="#the-basics" class="anchor" aria-hidden="true"></a>The basics</h3>
<p>The base <strong>surveil</strong> model specification is specified as follows. The Poisson model is used as the likelihood: the probability of observing a given number of cases, <span class="math inline">\(y_t\)</span>, conditional on unknown level of risk, <span class="math inline">\(e^{\phi_t}\)</span>, and known population at risk, <span class="math inline">\(p_t\)</span>: <span class="math display">\[y_t \sim \text{Pois}(p_t \cdot e^{\phi_t})\]</span> where <span class="math inline">\(t\)</span> indexes the time period.</p>
<p>Next, we build a model for the log-rates, <span class="math inline">\({\phi_t}\)</span>. The first-difference prior states that our expectation for the log-rate at any time is its previous value, and we assign a Gaussian probability distribution to deviations from the previous value <span class="citation">(Clayton <a href="#ref-clayton_1996">1996</a>)</span>. This is also known as the random-walk prior: <span class="math display">\[\phi_t \sim \text{Gau}(\phi_{t-1}, \tau^2)\]</span> This places higher probability on a smooth trend through time, specifically implying that underlying disease risk tends to have less variation than crude incidence.</p>
<p>The log-risk for time <span class="math inline">\(t=1\)</span> has no previous value to anchor its expectation; thus, we assign a prior probability distribution directly to <span class="math inline">\(\phi_1\)</span>. For this prior, <strong>surveil</strong> uses a Gaussian distribution. The scale parameter, <span class="math inline">\(\tau\)</span>, also requires a prior distribution, and again <strong>surveil</strong> uses a Gaussian model.</p>
</div>
<div id="multiple-time-series" class="section level3">
<h3 class="hasAnchor">
<a href="#multiple-time-series" class="anchor" aria-hidden="true"></a>Multiple time series</h3>
<p>For multiple time series, <strong>surveil</strong> allows users to add a correlation structure to the model. This allows our inferences about each population to be mutually informed by inferences about all other observed populations.</p>
<p>The log-rates for <span class="math inline">\(k\)</span> populations, <span class="math inline">\(\boldsymbol \phi_t\)</span>, are assigned a multivariate Gaussian model <span class="citation">(Brandt and Williams <a href="#ref-brandt_2007">2007</a>)</span>: <span class="math display">\[\boldsymbol \phi_t \sim \text{Gau}(\boldsymbol \phi_{t-1}, \boldsymbol \Sigma),\]</span> where <span class="math inline">\(\boldsymbol \Sigma\)</span> is a <span class="math inline">\(k \times k\)</span> covariance matrix.</p>
<p>The covariance matrix can be decomposed into a diagonal matrix containing scale parameters for each variable, <span class="math inline">\(\boldsymbol \Delta = diag(\tau_1,\dots \tau_k)\)</span>, and a symmetric correlation matrix, <span class="math inline">\(\boldsymbol \Omega\)</span> <span class="citation">(Stan Development Team <a href="#ref-stan_2021">2021</a>)</span>: <span class="math display">\[\boldsymbol \Sigma = \boldsymbol \Delta \boldsymbol \Omega \boldsymbol \Delta\]</span> When the correlation structure is added to the model, then a prior distribution is also required for the correlation matrix. <strong>surveil</strong> uses the LKJ model, which has a single shape parameter, <span class="math inline">\(\eta\)</span> <span class="citation">(Stan Development Team <a href="#ref-stan_2021">2021</a>)</span>. If <span class="math inline">\(\eta=1\)</span>, the LKJ model will place uniform prior probability on any <span class="math inline">\(k \times k\)</span> correlation matrix; as <span class="math inline">\(\eta\)</span> increases from one, it expresses ever greater skepticism towards large correlations. When <span class="math inline">\(\eta &lt;1\)</span>, the LKJ model becomes ‘concave’—expressing skepticism towards correlations of zero.</p>
</div>
</div>
<div id="fitting-the-model" class="section level2">
<h2 class="hasAnchor">
<a href="#fitting-the-model" class="anchor" aria-hidden="true"></a>Fitting the model</h2>
<p>The time series model is fit by passing surveillance data to the <code>stan_rw</code> function. Here, <code>Year</code> and <code>Race</code> indicate the appropriate time and grouping columns in the <code>tx.msa</code> data frame.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/stan_rw.html">stan_rw</a></span><span class="op">(</span><span class="va">tx.msa</span>, time <span class="op">=</span> <span class="va">Year</span>, group <span class="op">=</span> <span class="va">Race</span><span class="op">)</span>
<span class="co">#&gt; Distribution: normal</span>
<span class="co">#&gt; Distribution: normal</span>
<span class="co">#&gt; [1] "Setting normal prior(s) for eta_1: "</span>
<span class="co">#&gt;  location scale</span>
<span class="co">#&gt;        -5    10</span>
<span class="co">#&gt; [1] "\nSetting half-normal prior for sigma: "</span>
<span class="co">#&gt;  location scale</span>
<span class="co">#&gt;         0     1</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; SAMPLING FOR MODEL 'poissonRW' NOW (CHAIN 1).</span>
<span class="co">#&gt; Chain 1: </span>
<span class="co">#&gt; Chain 1: Gradient evaluation took 4.6e-05 seconds</span>
<span class="co">#&gt; Chain 1: 1000 transitions using 10 leapfrog steps per transition would take 0.46 seconds.</span>
<span class="co">#&gt; Chain 1: Adjust your expectations accordingly!</span>
<span class="co">#&gt; Chain 1: </span>
<span class="co">#&gt; Chain 1: </span>
<span class="co">#&gt; Chain 1: Iteration:    1 / 3000 [  0%]  (Warmup)</span>
<span class="co">#&gt; Chain 1: Iteration: 1500 / 3000 [ 50%]  (Warmup)</span>
<span class="co">#&gt; Chain 1: Iteration: 1501 / 3000 [ 50%]  (Sampling)</span>
<span class="co">#&gt; Chain 1: Iteration: 3000 / 3000 [100%]  (Sampling)</span>
<span class="co">#&gt; Chain 1: </span>
<span class="co">#&gt; Chain 1:  Elapsed Time: 0.364382 seconds (Warm-up)</span>
<span class="co">#&gt; Chain 1:                0.357079 seconds (Sampling)</span>
<span class="co">#&gt; Chain 1:                0.721461 seconds (Total)</span>
<span class="co">#&gt; Chain 1: </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; SAMPLING FOR MODEL 'poissonRW' NOW (CHAIN 2).</span>
<span class="co">#&gt; Chain 2: </span>
<span class="co">#&gt; Chain 2: Gradient evaluation took 1.2e-05 seconds</span>
<span class="co">#&gt; Chain 2: 1000 transitions using 10 leapfrog steps per transition would take 0.12 seconds.</span>
<span class="co">#&gt; Chain 2: Adjust your expectations accordingly!</span>
<span class="co">#&gt; Chain 2: </span>
<span class="co">#&gt; Chain 2: </span>
<span class="co">#&gt; Chain 2: Iteration:    1 / 3000 [  0%]  (Warmup)</span>
<span class="co">#&gt; Chain 2: Iteration: 1500 / 3000 [ 50%]  (Warmup)</span>
<span class="co">#&gt; Chain 2: Iteration: 1501 / 3000 [ 50%]  (Sampling)</span>
<span class="co">#&gt; Chain 2: Iteration: 3000 / 3000 [100%]  (Sampling)</span>
<span class="co">#&gt; Chain 2: </span>
<span class="co">#&gt; Chain 2:  Elapsed Time: 0.368745 seconds (Warm-up)</span>
<span class="co">#&gt; Chain 2:                0.357346 seconds (Sampling)</span>
<span class="co">#&gt; Chain 2:                0.726091 seconds (Total)</span>
<span class="co">#&gt; Chain 2: </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; SAMPLING FOR MODEL 'poissonRW' NOW (CHAIN 3).</span>
<span class="co">#&gt; Chain 3: </span>
<span class="co">#&gt; Chain 3: Gradient evaluation took 1.2e-05 seconds</span>
<span class="co">#&gt; Chain 3: 1000 transitions using 10 leapfrog steps per transition would take 0.12 seconds.</span>
<span class="co">#&gt; Chain 3: Adjust your expectations accordingly!</span>
<span class="co">#&gt; Chain 3: </span>
<span class="co">#&gt; Chain 3: </span>
<span class="co">#&gt; Chain 3: Iteration:    1 / 3000 [  0%]  (Warmup)</span>
<span class="co">#&gt; Chain 3: Iteration: 1500 / 3000 [ 50%]  (Warmup)</span>
<span class="co">#&gt; Chain 3: Iteration: 1501 / 3000 [ 50%]  (Sampling)</span>
<span class="co">#&gt; Chain 3: Iteration: 3000 / 3000 [100%]  (Sampling)</span>
<span class="co">#&gt; Chain 3: </span>
<span class="co">#&gt; Chain 3:  Elapsed Time: 0.364684 seconds (Warm-up)</span>
<span class="co">#&gt; Chain 3:                0.357253 seconds (Sampling)</span>
<span class="co">#&gt; Chain 3:                0.721937 seconds (Total)</span>
<span class="co">#&gt; Chain 3: </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; SAMPLING FOR MODEL 'poissonRW' NOW (CHAIN 4).</span>
<span class="co">#&gt; Chain 4: </span>
<span class="co">#&gt; Chain 4: Gradient evaluation took 1.1e-05 seconds</span>
<span class="co">#&gt; Chain 4: 1000 transitions using 10 leapfrog steps per transition would take 0.11 seconds.</span>
<span class="co">#&gt; Chain 4: Adjust your expectations accordingly!</span>
<span class="co">#&gt; Chain 4: </span>
<span class="co">#&gt; Chain 4: </span>
<span class="co">#&gt; Chain 4: Iteration:    1 / 3000 [  0%]  (Warmup)</span>
<span class="co">#&gt; Chain 4: Iteration: 1500 / 3000 [ 50%]  (Warmup)</span>
<span class="co">#&gt; Chain 4: Iteration: 1501 / 3000 [ 50%]  (Sampling)</span>
<span class="co">#&gt; Chain 4: Iteration: 3000 / 3000 [100%]  (Sampling)</span>
<span class="co">#&gt; Chain 4: </span>
<span class="co">#&gt; Chain 4:  Elapsed Time: 0.38598 seconds (Warm-up)</span>
<span class="co">#&gt; Chain 4:                0.353829 seconds (Sampling)</span>
<span class="co">#&gt; Chain 4:                0.739809 seconds (Total)</span>
<span class="co">#&gt; Chain 4:</span></code></pre></div>
<p>If we wanted to add a correlation structure to the model, we would add <code>cor = TRUE</code> (as opposed to the default, <code>cor = FALSE</code>). To speed things up, we could take advantage of parallel processing using the <code>cores</code> argument (e.g., by adding <code>cores = 4</code> to run on 4 cores simultaneously). Note also that it is important to read and address any warning messages related to Stan’s MCMC diagnostics. In this case, the sampling finished without any warnings, so we can proceed with our analysis.</p>
</div>
<div id="visualizing-results" class="section level2">
<h2 class="hasAnchor">
<a href="#visualizing-results" class="anchor" aria-hidden="true"></a>Visualizing results</h2>
<p>If we call <code>plot</code> on a <code>surveil</code> model, we get a <code>ggplot</code> object:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">fit</span>, scale <span class="op">=</span> <span class="fl">100e3</span><span class="op">)</span>
<span class="co">#&gt; Plotted rates are per 100,000</span></code></pre></div>
<p><img src="demonstration_files/figure-html/unnamed-chunk-7-1.png" width="384" style="display: block; margin: auto;"></p>
<p>Instead of viewing the default plot, we can first store the `<code>ggplot</code> in our working environment and then modify the figure as we please:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">fig</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">fit</span>, scale <span class="op">=</span> <span class="fl">100e3</span><span class="op">)</span>
<span class="co">#&gt; Plotted rates are per 100,000</span>
<span class="va">fig</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_brewer.html" class="external-link">scale_color_brewer</a></span><span class="op">(</span>breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Black or African American"</span>, <span class="st">"White"</span>, <span class="st">"Hispanic"</span><span class="op">)</span>,
                     labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Black"</span>, <span class="st">"White"</span>, <span class="st">"Hispanic"</span><span class="op">)</span>,
             name <span class="op">=</span> <span class="cn">NULL</span>,
             type <span class="op">=</span> <span class="st">'qual'</span><span class="op">)</span>    
<span class="co">#&gt; Scale for 'colour' is already present. Adding another scale for 'colour',</span>
<span class="co">#&gt; which will replace the existing scale.</span></code></pre></div>
<p><img src="demonstration_files/figure-html/unnamed-chunk-8-1.png" width="384" style="display: block; margin: auto;"></p>
<p>The plot method has a <code>style</code> argument that controls how the probability distribution is represented. The default, <code>style = "mean_qi"</code>, shows the mean of the posterior distribution of the risk at each time period with a shaded 95% credible interval (as above). The alternative, <code>style = "lines"</code>, plots MCMC samples from the joint probability distribution across all time periods:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">fit</span>, scale <span class="op">=</span> <span class="fl">100e3</span>, style <span class="op">=</span> <span class="st">"lines"</span><span class="op">)</span>
<span class="co">#&gt; Plotted rates are per 100,000</span></code></pre></div>
<p><img src="demonstration_files/figure-html/unnamed-chunk-9-1.png" width="384" style="display: block; margin: auto;"></p>
<p>By default, <code>M = 250</code> samples are plotted. The <code>style</code> option is available for all of the <code>surveil</code> plot methods.</p>
</div>
<div id="measuring-pairwise-inequality" class="section level2">
<h2 class="hasAnchor">
<a href="#measuring-pairwise-inequality" class="anchor" aria-hidden="true"></a>Measuring pairwise inequality</h2>
<p><strong>surveil</strong> also provides a number of functions and methods for measuring health inequalities.</p>
<p>A selection of complementary pairwise inequality measures can be calculated using the <code>group_diff</code> function. The function requires a fitted <strong>surveil</strong> model and character strings corresponding, respectively, to the target population (indicating which group is the target of our inference, typically the overburdened or disadvantaged group), and the reference population. It returns probability distributions and summary statements for the following quantities, where <code>target</code> and <code>reference</code> indicate disease risk for the respective populations:</p>
<ul>
<li>Rate Difference (RD): <span class="math inline">\(\text{Target} - \text{Reference}\)</span>;</li>
<li>Population Attributable Risk (PAR): <span class="math inline">\(\frac{\text{RD}}{\text{Target}}\)</span>;</li>
<li>Rate Ratio (RR): <span class="math inline">\(\frac{\text{Target}}{\text{Reference}}\)</span>;</li>
<li>Excess Cases (EC): <span class="math inline">\(\text{RD} \times \text{[At Risk]}\)</span>.</li>
</ul>
<p>Notice that the PAR is simply the rate difference expressed as a fraction of total risk; it indicates the fraction of risk in the target population that would have been removed had the target rate equaled the reference rate <span class="citation">(Menvielle, Kulhánová, and Machenbach <a href="#ref-menvielle_2019">2019</a>)</span>.</p>
<p>To calculate all of these measures for two groups in our data, we call <code>group_diff</code> on our fitted model:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">gd</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/group_diff.html">group_diff</a></span><span class="op">(</span><span class="va">fit</span>, target <span class="op">=</span> <span class="st">"Black or African American"</span>, reference <span class="op">=</span> <span class="st">"White"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">gd</span>, scale <span class="op">=</span> <span class="fl">100e3</span><span class="op">)</span>
<span class="co">#&gt; Summary of Pairwise Inequality</span>
<span class="co">#&gt; Target group: Black or African American</span>
<span class="co">#&gt; Reference group: White</span>
<span class="co">#&gt; Time periods observed: 19</span>
<span class="co">#&gt; Rate scale: per 100,000</span>
<span class="co">#&gt; Cumulative excess cases (EC): 3,206 [2986, 3440]</span>
<span class="co">#&gt; Cumulative EC as a fraction of group risk (PAR): 0.27 [0.25, 0.28]</span>
<span class="co">#&gt;  time Rate RD  PAR  RR  EC</span>
<span class="co">#&gt;  1999  170 35 0.20 1.3  95</span>
<span class="co">#&gt;  2000  166 30 0.18 1.2  85</span>
<span class="co">#&gt;  2001  168 34 0.20 1.3 102</span>
<span class="co">#&gt;  2002  169 39 0.23 1.3 122</span>
<span class="co">#&gt;  2003  167 40 0.24 1.3 131</span>
<span class="co">#&gt;  2004  167 47 0.28 1.4 162</span>
<span class="co">#&gt;  2005  159 44 0.28 1.4 161</span>
<span class="co">#&gt;  2006  155 45 0.29 1.4 179</span>
<span class="co">#&gt;  2007  153 44 0.29 1.4 186</span>
<span class="co">#&gt;  2008  150 46 0.31 1.4 203</span>
<span class="co">#&gt;  2009  144 45 0.31 1.5 208</span>
<span class="co">#&gt;  2010  139 43 0.31 1.4 209</span>
<span class="co">#&gt;  2011  131 37 0.28 1.4 191</span>
<span class="co">#&gt;  2012  125 34 0.27 1.4 184</span>
<span class="co">#&gt;  2013  125 35 0.28 1.4 196</span>
<span class="co">#&gt;  2014  126 35 0.27 1.4 204</span>
<span class="co">#&gt;  2015  122 29 0.24 1.3 180</span>
<span class="co">#&gt;  2016  122 33 0.27 1.4 209</span>
<span class="co">#&gt;  2017  122 30 0.25 1.3 199</span></code></pre></div>
<p>All of the <strong>surveil</strong> plotting and printing methods provide an option to scale rates by a custom value. By setting <code>scale = 100e3</code> (100,000), the RD is printed as cases per 100,000. Note that none of the other inequality measures (PAR, RR, EC) are ever impacted by this choice.</p>
<p>The plot method for <code>surveil_diff</code> produces one time series <code>ggplot</code> each for RD, PAR, and EC. The means of the probability distributions for each measure are plotted as lines, while the shading indicates a 95% credible interval:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">gd</span>, scale <span class="op">=</span> <span class="fl">100e3</span><span class="op">)</span>
<span class="co">#&gt; Rate differences (RD) are per 100,000 at risk</span></code></pre></div>
<p><img src="demonstration_files/figure-html/unnamed-chunk-11-1.png" width="336" style="display: block; margin: auto;"></p>
<p>If we wanted to replace the plot of the PAR with one of the RR, we would set the <code>PAR</code> option to <code>FALSE</code>:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">gd</span>, scale <span class="op">=</span> <span class="fl">100e3</span>, PAR <span class="op">=</span> <span class="cn">FALSE</span>, style <span class="op">=</span> <span class="st">"lines"</span><span class="op">)</span>
<span class="co">#&gt; Rate differences (RD) are per 100,000 at risk</span></code></pre></div>
<p><img src="demonstration_files/figure-html/unnamed-chunk-12-1.png" width="336" style="display: block; margin: auto;"></p>
</div>
<div id="measuring-inequality-with-multiple-groups" class="section level2">
<h2 class="hasAnchor">
<a href="#measuring-inequality-with-multiple-groups" class="anchor" aria-hidden="true"></a>Measuring inequality with multiple groups</h2>
<p>Pairwise measures are important, but they cannot provide a summary of inequality across multiple socially situated groups. Theil’s T is an entropy-based inequality index with many favorable qualities, including that it naturally accommodates complex grouping structures <span class="citation">(Theil <a href="#ref-theil_1972">1972</a>; Conceição and Galbraith <a href="#ref-conceicao_2000a">2000</a>; Conceição and Ferreira <a href="#ref-conceicao_2000b">2000</a>)</span>.</p>
<p>Theil’s T measures the extent to which certain populations are overburdened by disease, meaning precisely that the proportion of cases accounted for by a particular group, <span class="math inline">\(\omega_j\)</span>, is higher than the proportion of the population constituted by that same group, <span class="math inline">\(\eta_j\)</span>. With <span class="math inline">\(k\)</span> groups, Theil’s index is <span class="math display">\[T = \sum_{j=1}^k \omega_j \big[ log(\omega_j / \eta_j) \big].\]</span> This is zero when case shares equal population shares and it increases monotonically as the two diverge for any group. Theil’s T is thus a weighted mean of log-ratios of case shares to population shares, where each log-ratio (which we may describe as a raw inequality score) is weighted by its share of total cases.</p>
<p>Theil’s T can be computed from a fitted <strong>surveil</strong> model, the only requirement is that the model includes multiple groups (through the <code>group</code> argument):</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">Ts</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/theil.html">theil</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">Ts</span><span class="op">)</span>
<span class="co">#&gt; Summary of Theil's Inequality Index</span>
<span class="co">#&gt; Groups:</span>
<span class="co">#&gt; Time periods observed: 19</span>
<span class="co">#&gt; Theil's T (times 100) with 95% credible intervals</span>
<span class="co">#&gt;  time Theil .lower .upper</span>
<span class="co">#&gt;  1999 0.942  0.639  1.304</span>
<span class="co">#&gt;  2000 0.797  0.525  1.089</span>
<span class="co">#&gt;  2001 0.903  0.626  1.203</span>
<span class="co">#&gt;  2002 0.982  0.690  1.307</span>
<span class="co">#&gt;  2003 0.996  0.710  1.315</span>
<span class="co">#&gt;  2004 1.071  0.755  1.445</span>
<span class="co">#&gt;  2005 1.000  0.700  1.351</span>
<span class="co">#&gt;  2006 1.044  0.716  1.402</span>
<span class="co">#&gt;  2007 1.100  0.780  1.460</span>
<span class="co">#&gt;  2008 1.242  0.897  1.659</span>
<span class="co">#&gt;  2009 1.201  0.849  1.597</span>
<span class="co">#&gt;  2010 1.132  0.798  1.533</span>
<span class="co">#&gt;  2011 0.912  0.601  1.270</span>
<span class="co">#&gt;  2012 0.768  0.480  1.091</span>
<span class="co">#&gt;  2013 0.806  0.532  1.123</span>
<span class="co">#&gt;  2014 0.858  0.577  1.200</span>
<span class="co">#&gt;  2015 0.681  0.429  0.966</span>
<span class="co">#&gt;  2016 0.803  0.530  1.118</span>
<span class="co">#&gt;  2017 0.715  0.435  1.047</span></code></pre></div>
<p>The probability distribution for Theil’s T can be summarized visualy using the <code>"lines"</code> style plot or by plotting estimates with shaded 95% credible intervals:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">Ts</span><span class="op">)</span></code></pre></div>
<p><img src="demonstration_files/figure-html/unnamed-chunk-14-1.png" width="384" style="display: block; margin: auto;"></p>
<p>While the minimum of Theil’s index is always zero, the maximum value varies with the structure of the population under observation. The index is useful for comparisons such as monitoring change over time, and should generally not be used as a indication of the absolute level of inequality.</p>
<p>The index also has interesting extensions; for example, given disease data for a nested population structure—such as racial-ethnic groups within states—Theil’s index can provide a measure of geographic inequality across states (between-state inequality), and social inequality within states (within-state inequality). For details, see <code><a href="../reference/theil.html">?theil</a></code>.</p>
</div>
<div id="references" class="section level2 unnumbered">
<h2 class="hasAnchor">
<a href="#references" class="anchor" aria-hidden="true"></a>References</h2>
<div id="refs" class="references">
<div id="ref-brandt_2007">
<p>Brandt, P, and JT Williams. 2007. <em>Multiple Time Series Models</em>. Sage.</p>
</div>
<div id="ref-clayton_1996">
<p>Clayton, DG. 1996. “Generalized Linear Mixed Models.” In <em>Markov Chain Monte Carlo in Practice: Interdisciplinary Statistics</em>, edited by WR Gilks, S Richardson, and DJ Spiegelhalter, 275–302. CRC Press.</p>
</div>
<div id="ref-conceicao_2000b">
<p>Conceição, Pedro, and Pedro Ferreira. 2000. “The Young Person’s Guide to the Theil Index: Suggesting Intuitive Interpretations and Exploring Analytical Applications.” <em>University of Texas Inequality Project (UTIP)</em>. <a href="https://utip.gov.utexas.edu/papers.html" class="external-link">https://utip.gov.utexas.edu/papers.html</a>.</p>
</div>
<div id="ref-conceicao_2000a">
<p>Conceição, Pedro, and James K. Galbraith. 2000. “Constructing Long and Dense Time Series of Inequality Using the Theil Index.” <em>Eastern Economic Journal</em> 26 (1): 61–74.</p>
</div>
<div id="ref-jaynes_2003">
<p>Jaynes, Edwin T. 2003. <em>Probability Theory: The Logic of Science</em>. Cambridge University Press.</p>
</div>
<div id="ref-mackay_2003">
<p>MacKay, David M. 2003. <em>Information Theory, Inference, and Learning Algorithms</em>. Cambridge University Press.</p>
</div>
<div id="ref-menvielle_2019">
<p>Menvielle, Gwenn, Kulhánová, and Johan P. Machenbach. 2019. “Assessing the Impact of a Public Health Intervention to Reduce Social Inequalities in Cancer.” In <em>Reducing Social Inequalities in Cancer: Evidence and Priorities for Research</em>, edited by Salvatore Vaccarella, Joannie Lortet-Tieulent, Rodolfo Saracci, David I. Conway, Kurt Straif, and Christopher P. Wild, 185–92. Geneva, Switzerland: WHO Press.</p>
</div>
<div id="ref-stan_2021">
<p>Stan Development Team. 2021. <em>Stan Modeling Language Users Guide and Reference Manual, 2.28</em>. <a href="https://mc-stan.org" class="external-link">https://mc-stan.org</a>.</p>
</div>
<div id="ref-theil_1972">
<p>Theil, Henry. 1972. <em>Statistical Decomposition Analysis</em>. Amsterdam, The Netherlands; London, UK: North-Holland Publishing Company.</p>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Connor Donegan.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link external-link">pkgdown</a> 1.6.1.9001.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
