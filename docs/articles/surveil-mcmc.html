<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Markov chain Monte Carlo (MCMC): analysis and diagnostics • surveil</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/sandstone/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Markov chain Monte Carlo (MCMC): analysis and diagnostics">
<meta property="og:description" content="surveil">
<meta property="og:image" content="https://connordonegan.github.io/surveil/, https://cloud.r-project.org/web/packages/surveil/index.html/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-116873024-1"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-116873024-1');
</script>
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">surveil</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.2.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../articles/index.html">Articles</a>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/ConnorDonegan/surveil/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Markov chain Monte Carlo (MCMC): analysis and diagnostics</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/ConnorDonegan/surveil/blob/HEAD/vignettes/surveil-mcmc.Rmd" class="external-link"><code>vignettes/surveil-mcmc.Rmd</code></a></small>
      <div class="hidden name"><code>surveil-mcmc.Rmd</code></div>

    </div>

    
    
<p>This vignette shows <strong>surveil</strong> users how to access and review Markov chain Monte Carlo (MCMC) diagnostics from <strong>surveil</strong> models. This not a complete resource for understanding MCMC, and readers are encouraged to seek additional resources.</p>
<p>Markov chain Monte Carlo (MCMC) algorithms, such as the Hamiltonian Monte Carlo algorithm that Stan (and therefore <strong>surveil</strong>) uses, aim to draw samples from the probability distribution specified by the user. The algorithm tries to explore the probability distribution extensively, and when successful, the resulting samples provide an approximate image of the target probability distribution.</p>
<p>Books that discuss MCMC include <span class="citation">MacKay (<a href="#ref-mackay_2003">2003</a>)</span> and <span class="citation">Gelman et al. (<a href="#ref-gelman_2014">2014</a>)</span>; see also <span class="citation">Vehtari et al. (<a href="#ref-vehtari_2021">2021</a>)</span>.</p>
<p>The following topics will be introduced here:</p>
<ul>
<li>Monte Carlo standard errors (MCSE)</li>
<li>Effective sample size (ESS)</li>
<li>The split Rhat statistic</li>
<li>Divergent transitions</li>
</ul>
<p>The first section examines MCMC samples from an example model in order to provide a foundation for the rest of the vignette. It is intended for users without prior exposure to MCMC analysis.</p>
<div class="section level2">
<h2 id="example-model">Example model<a class="anchor" aria-label="anchor" href="#example-model"></a>
</h2>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://connordonegan.github.io/surveil/" class="external-link">surveil</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://mc-stan.org/rstan/" class="external-link">rstan</a></span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">cancer</span><span class="op">)</span></code></pre></div>
<p>The discussion will make use of a model of U.S. cancer incidence rates, ages 10-14 from the <code>cancer</code> data:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">data2</span> <span class="op">&lt;-</span> <span class="va">cancer</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">cancer</span><span class="op">$</span><span class="va">Age</span> <span class="op">==</span> <span class="st">"10-14"</span><span class="op">)</span>,<span class="op">]</span>
<span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/stan_rw.html">stan_rw</a></span><span class="op">(</span><span class="va">data2</span>, time <span class="op">=</span> <span class="va">Year</span><span class="op">)</span>
<span class="co">#&gt; Distribution: normal</span>
<span class="co">#&gt; Distribution: normal</span>
<span class="co">#&gt; [1] "Setting normal prior(s) for eta_1: "</span>
<span class="co">#&gt;  location scale</span>
<span class="co">#&gt;        -6     5</span>
<span class="co">#&gt; [1] "\nSetting half-normal prior for sigma: "</span>
<span class="co">#&gt;  location scale</span>
<span class="co">#&gt;         0     1</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; SAMPLING FOR MODEL 'RW' NOW (CHAIN 1).</span>
<span class="co">#&gt; Chain 1: </span>
<span class="co">#&gt; Chain 1: Gradient evaluation took 2.1e-05 seconds</span>
<span class="co">#&gt; Chain 1: 1000 transitions using 10 leapfrog steps per transition would take 0.21 seconds.</span>
<span class="co">#&gt; Chain 1: Adjust your expectations accordingly!</span>
<span class="co">#&gt; Chain 1: </span>
<span class="co">#&gt; Chain 1: </span>
<span class="co">#&gt; Chain 1: Iteration:    1 / 3000 [  0%]  (Warmup)</span>
<span class="co">#&gt; Chain 1: Iteration: 1500 / 3000 [ 50%]  (Warmup)</span>
<span class="co">#&gt; Chain 1: Iteration: 1501 / 3000 [ 50%]  (Sampling)</span>
<span class="co">#&gt; Chain 1: Iteration: 3000 / 3000 [100%]  (Sampling)</span>
<span class="co">#&gt; Chain 1: </span>
<span class="co">#&gt; Chain 1:  Elapsed Time: 0.158713 seconds (Warm-up)</span>
<span class="co">#&gt; Chain 1:                0.167921 seconds (Sampling)</span>
<span class="co">#&gt; Chain 1:                0.326634 seconds (Total)</span>
<span class="co">#&gt; Chain 1: </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; SAMPLING FOR MODEL 'RW' NOW (CHAIN 2).</span>
<span class="co">#&gt; Chain 2: </span>
<span class="co">#&gt; Chain 2: Gradient evaluation took 8e-06 seconds</span>
<span class="co">#&gt; Chain 2: 1000 transitions using 10 leapfrog steps per transition would take 0.08 seconds.</span>
<span class="co">#&gt; Chain 2: Adjust your expectations accordingly!</span>
<span class="co">#&gt; Chain 2: </span>
<span class="co">#&gt; Chain 2: </span>
<span class="co">#&gt; Chain 2: Iteration:    1 / 3000 [  0%]  (Warmup)</span>
<span class="co">#&gt; Chain 2: Iteration: 1500 / 3000 [ 50%]  (Warmup)</span>
<span class="co">#&gt; Chain 2: Iteration: 1501 / 3000 [ 50%]  (Sampling)</span>
<span class="co">#&gt; Chain 2: Iteration: 3000 / 3000 [100%]  (Sampling)</span>
<span class="co">#&gt; Chain 2: </span>
<span class="co">#&gt; Chain 2:  Elapsed Time: 0.176986 seconds (Warm-up)</span>
<span class="co">#&gt; Chain 2:                0.121392 seconds (Sampling)</span>
<span class="co">#&gt; Chain 2:                0.298378 seconds (Total)</span>
<span class="co">#&gt; Chain 2: </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; SAMPLING FOR MODEL 'RW' NOW (CHAIN 3).</span>
<span class="co">#&gt; Chain 3: </span>
<span class="co">#&gt; Chain 3: Gradient evaluation took 7e-06 seconds</span>
<span class="co">#&gt; Chain 3: 1000 transitions using 10 leapfrog steps per transition would take 0.07 seconds.</span>
<span class="co">#&gt; Chain 3: Adjust your expectations accordingly!</span>
<span class="co">#&gt; Chain 3: </span>
<span class="co">#&gt; Chain 3: </span>
<span class="co">#&gt; Chain 3: Iteration:    1 / 3000 [  0%]  (Warmup)</span>
<span class="co">#&gt; Chain 3: Iteration: 1500 / 3000 [ 50%]  (Warmup)</span>
<span class="co">#&gt; Chain 3: Iteration: 1501 / 3000 [ 50%]  (Sampling)</span>
<span class="co">#&gt; Chain 3: Iteration: 3000 / 3000 [100%]  (Sampling)</span>
<span class="co">#&gt; Chain 3: </span>
<span class="co">#&gt; Chain 3:  Elapsed Time: 0.155636 seconds (Warm-up)</span>
<span class="co">#&gt; Chain 3:                0.118698 seconds (Sampling)</span>
<span class="co">#&gt; Chain 3:                0.274334 seconds (Total)</span>
<span class="co">#&gt; Chain 3: </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; SAMPLING FOR MODEL 'RW' NOW (CHAIN 4).</span>
<span class="co">#&gt; Chain 4: </span>
<span class="co">#&gt; Chain 4: Gradient evaluation took 8e-06 seconds</span>
<span class="co">#&gt; Chain 4: 1000 transitions using 10 leapfrog steps per transition would take 0.08 seconds.</span>
<span class="co">#&gt; Chain 4: Adjust your expectations accordingly!</span>
<span class="co">#&gt; Chain 4: </span>
<span class="co">#&gt; Chain 4: </span>
<span class="co">#&gt; Chain 4: Iteration:    1 / 3000 [  0%]  (Warmup)</span>
<span class="co">#&gt; Chain 4: Iteration: 1500 / 3000 [ 50%]  (Warmup)</span>
<span class="co">#&gt; Chain 4: Iteration: 1501 / 3000 [ 50%]  (Sampling)</span>
<span class="co">#&gt; Chain 4: Iteration: 3000 / 3000 [100%]  (Sampling)</span>
<span class="co">#&gt; Chain 4: </span>
<span class="co">#&gt; Chain 4:  Elapsed Time: 0.155212 seconds (Warm-up)</span>
<span class="co">#&gt; Chain 4:                0.115851 seconds (Sampling)</span>
<span class="co">#&gt; Chain 4:                0.271063 seconds (Total)</span>
<span class="co">#&gt; Chain 4:</span></code></pre></div>
<p>Given 4 MCMC chains, 3,000 samples drawn from each chain, and the first <code>.5 * 3000 = 1500</code> samples discarded as warmup, the <code>fit</code> object contains 6,000 MCMC samples. There is one parameter per year, each representing the level of cancer risk. There are 19 years of data (1999-2017). The number of samples required depends upon a number of factors, and in some cases the default settings may be more or less than is needed. One should draw enough samples that 1) the Monte Carlo standard errors are sufficiently small, and 2) the MCMC chains have had time to converge on a single distribution (these concepts will be discussed below).</p>
<p>The <code>print</code> method will return a summary of the marginal probability distributions for each year:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">fit</span>, scale <span class="op">=</span> <span class="fl">100e3</span><span class="op">)</span>
<span class="co">#&gt; Summary of surveil model results</span>
<span class="co">#&gt; Time periods: 19</span>
<span class="co">#&gt;    time     mean  lwr_2.5 upr_97.5</span>
<span class="co">#&gt; 1  1999 12.49860 12.08195 12.90519</span>
<span class="co">#&gt; 2  2000 12.63423 12.27038 12.99648</span>
<span class="co">#&gt; 3  2001 12.98531 12.62376 13.38241</span>
<span class="co">#&gt; 4  2002 12.85369 12.49429 13.20499</span>
<span class="co">#&gt; 5  2003 12.93050 12.57350 13.28096</span>
<span class="co">#&gt; 6  2004 13.20919 12.84645 13.58091</span>
<span class="co">#&gt; 7  2005 13.16713 12.80228 13.52552</span>
<span class="co">#&gt; 8  2006 13.37128 12.99992 13.74272</span>
<span class="co">#&gt; 9  2007 13.34730 12.96787 13.70997</span>
<span class="co">#&gt; 10 2008 13.47652 13.10478 13.84362</span>
<span class="co">#&gt; 11 2009 13.72782 13.35089 14.10669</span>
<span class="co">#&gt; 12 2010 14.06284 13.67721 14.45778</span>
<span class="co">#&gt; 13 2011 14.19511 13.82421 14.57321</span>
<span class="co">#&gt; 14 2012 14.42455 14.03621 14.81286</span>
<span class="co">#&gt; 15 2013 14.76534 14.37351 15.15582</span>
<span class="co">#&gt; 16 2014 15.18374 14.79305 15.60676</span>
<span class="co">#&gt; 17 2015 15.32782 14.93200 15.73757</span>
<span class="co">#&gt; 18 2016 15.52137 15.10149 15.96117</span>
<span class="co">#&gt; 19 2017 15.19286 14.75005 15.63650</span></code></pre></div>
<p>Adding <code>scale = 100e3</code> will report results in terms of cases per 100,000 persons at risk.</p>
<p>The <code>mean</code> refers to the mean of the MCMC samples and the <code>lwr_2.5</code> and <code>upr_97.5</code> report the bounds of the central 95% quantile interval (or credible interval: CI).</p>
</div>
<div class="section level2">
<h2 id="mcmc-analysis">MCMC analysis<a class="anchor" aria-label="anchor" href="#mcmc-analysis"></a>
</h2>
<p>We can examine the MCMC samples themselves to see how the values provided by the <code>print</code> method were calculated. The <code>stanfit</code> object created by Stan contains all of the MCMC samples:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">samples</span> <span class="op">&lt;-</span> <span class="va">fit</span><span class="op">$</span><span class="va">samples</span>
<span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">samples</span><span class="op">)</span>
<span class="va">phi</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">samples</span>, pars <span class="op">=</span> <span class="st">"rate"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">phi</span><span class="op">)</span>
<span class="co">#&gt; [1] "stanfit"</span>
<span class="co">#&gt; attr(,"package")</span>
<span class="co">#&gt; [1] "rstan"</span>
<span class="co">#&gt; [1] 6000   19</span></code></pre></div>
<p>Each row of the matrix <code>phi</code> is a sample from the joint posterior probability distribution of parameters, and each column represents a parameter (in this case, each parameter represents the level of cancer risk averaged over a given year). The values in any given column are samples from the marginal probability distribution for that parameter.</p>
<p>We can visualize the marginal distribution of cancer risk in 1999 for 10-14 year olds using a histogram; we will scale this in terms of cases per 100,000 persons at risk:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">phi_1999</span> <span class="op">&lt;-</span> <span class="va">phi</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span> <span class="op">*</span> <span class="fl">100e3</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">phi_1999</span><span class="op">)</span>
<span class="co">#&gt; [1] 12.93295 12.29204 12.17056 12.16100 12.52228 12.64901</span></code></pre></div>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/graphics/hist.html" class="external-link">hist</a></span><span class="op">(</span><span class="va">phi_1999</span>, main <span class="op">=</span> <span class="st">"Rate per 100,000"</span><span class="op">)</span></code></pre></div>
<p><img src="surveil-mcmc_files/figure-html/unnamed-chunk-7-1.png" width="480" style="display: block; margin: auto;"></p>
<p>To summarize this distribution, we can calculate the mean and select quantiles of the MCMC samples:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">phi_1999</span><span class="op">)</span>
<span class="co">#&gt; [1] 12.4986</span></code></pre></div>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">phi_1999</span>, probs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.025</span>, <span class="fl">0.1</span>, <span class="fl">0.9</span>, <span class="fl">0.975</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt;     2.5%      10%      90%    97.5% </span>
<span class="co">#&gt; 12.08195 12.22510 12.76636 12.90519</span></code></pre></div>
<p>If we did this for all years we would obtain the same information that was provided by <code>print(fit)</code>.</p>
<p>In order to make inferences about quantities that involve more than one parameter, we need to use samples from the joint probability distribution. We can visualize the joint distribution using the <code>plot</code> method:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">fit</span>, style <span class="op">=</span> <span class="st">"lines"</span>, scale <span class="op">=</span> <span class="fl">100e3</span><span class="op">)</span>
<span class="co">#&gt; Plotted rates are per 100,000</span></code></pre></div>
<p><img src="surveil-mcmc_files/figure-html/unnamed-chunk-10-1.png" width="480" style="display: block; margin: auto;"></p>
<p>Each line is a visual depiction of a row from the matrix of MCMC samples <code>phi</code>.</p>
<p>When calculating quantities of interest, like annual percent change, cumulative change, or a measure of inequality, one must always use the joint distribution. This means that the quantity of interest needs to be calculated by working row-wise, which will result in a vector of samples for the quantity of interest. To illustrate how this is done, the following code creates a new quantity: the difference between risk in 2017 (the <span class="math inline">\(19^{th}\)</span> year) and 1999 (the first observed year).</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">diff</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">phi</span><span class="op">[</span>,<span class="fl">19</span><span class="op">]</span> <span class="op">-</span> <span class="va">phi</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="op">*</span> <span class="fl">100e3</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/hist.html" class="external-link">hist</a></span><span class="op">(</span><span class="va">diff</span><span class="op">)</span></code></pre></div>
<p><img src="surveil-mcmc_files/figure-html/unnamed-chunk-11-1.png" width="480" style="display: block; margin: auto;"></p>
<p>The principle at work here is that you never summarize MCMC samples until after all of the calculations are done. The mean of the probability distribution for the change in risk over this period is:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">diff</span><span class="op">)</span>
<span class="co">#&gt; [1] 2.694257</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="monte-carlo-standard-errors">Monte Carlo standard errors<a class="anchor" aria-label="anchor" href="#monte-carlo-standard-errors"></a>
</h2>
<p>An important difference between sampling with an MCMC algorithm and sampling from a pseudo random number generator (like <code>rnorm</code>) is that MCMC produces samples that are (often) correlated with one another other. (That is, in the process of drawing MCMC samples, movement around the probability distribution is serially correlated.) This means that for any number of MCMC samples, there is less information than would be provided by the same number of independently drawn samples. To evaluate how far the mean of our MCMC samples may plausibly be from the mean of the target probability distribution, we need to consider Monte Carlo standard errors (MCSEs) for each parameter.</p>
<p>MCSEs are calculated as <span class="citation">(Gelman et al. <a href="#ref-gelman_2014">2014</a>)</span></p>
<p><span class="math display">\[MCSE(\phi) = \frac{\sqrt(Var(\phi))}{\sqrt(ESS(\phi))}\]</span></p>
<p>where <span class="math inline">\(Var(\phi)\)</span> is the variance of the posterior distribution for parameter <span class="math inline">\(\phi\)</span> and ESS is the effective sample size. ESS is adjusted for autocorrelation in the MCMC samples.</p>
<p>To view a histogram of MCSEs for all parameters in the <strong>surveil</strong> model, we can use <strong>rstan</strong>’s <code>stan_mcse</code> function:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stan_plot_diagnostics.html" class="external-link">stan_mcse</a></span><span class="op">(</span><span class="va">samples</span><span class="op">)</span>
<span class="co">#&gt; `stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</span></code></pre></div>
<p><img src="surveil-mcmc_files/figure-html/unnamed-chunk-13-1.png" width="384" style="display: block; margin: auto;"></p>
<p>Notice that instead of returning the MCSEs themselves, <strong>rstan</strong> divides the MCSEs by the scale of the probability distribution, <span class="math inline">\(\frac{MCSE(\phi)}{SD(\phi)}\)</span>. We can see that most of these values are under 0.04. We can always obtain smaller MCSEs by drawing a larger number of samples.</p>
<p>It may be more intuitive to examine the effective sample size (ESS) directly. You can start by printing the <code>fit$samples</code> object and examining the ESS directly. ESS is reported in the column labeled <code>n_eff</code>:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">samples</span><span class="op">)</span>
<span class="co">#&gt; Inference for Stan model: RW.</span>
<span class="co">#&gt; 4 chains, each with iter=3000; warmup=1500; thin=1; </span>
<span class="co">#&gt; post-warmup draws per chain=1500, total post-warmup draws=6000.</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;                 mean se_mean   sd   2.5%    25%    50%    75%  97.5% n_eff Rhat</span>
<span class="co">#&gt; rate[1,1]       0.00    0.00 0.00   0.00   0.00   0.00   0.00   0.00  5622    1</span>
<span class="co">#&gt; rate[1,2]       0.00    0.00 0.00   0.00   0.00   0.00   0.00   0.00  6041    1</span>
<span class="co">#&gt; rate[1,3]       0.00    0.00 0.00   0.00   0.00   0.00   0.00   0.00  5814    1</span>
<span class="co">#&gt; rate[1,4]       0.00    0.00 0.00   0.00   0.00   0.00   0.00   0.00  6903    1</span>
<span class="co">#&gt; rate[1,5]       0.00    0.00 0.00   0.00   0.00   0.00   0.00   0.00  6460    1</span>
<span class="co">#&gt; rate[1,6]       0.00    0.00 0.00   0.00   0.00   0.00   0.00   0.00  6485    1</span>
<span class="co">#&gt; rate[1,7]       0.00    0.00 0.00   0.00   0.00   0.00   0.00   0.00  7174    1</span>
<span class="co">#&gt; rate[1,8]       0.00    0.00 0.00   0.00   0.00   0.00   0.00   0.00  6553    1</span>
<span class="co">#&gt; rate[1,9]       0.00    0.00 0.00   0.00   0.00   0.00   0.00   0.00  5948    1</span>
<span class="co">#&gt; rate[1,10]      0.00    0.00 0.00   0.00   0.00   0.00   0.00   0.00  6925    1</span>
<span class="co">#&gt; rate[1,11]      0.00    0.00 0.00   0.00   0.00   0.00   0.00   0.00  6960    1</span>
<span class="co">#&gt; rate[1,12]      0.00    0.00 0.00   0.00   0.00   0.00   0.00   0.00  7180    1</span>
<span class="co">#&gt; rate[1,13]      0.00    0.00 0.00   0.00   0.00   0.00   0.00   0.00  7665    1</span>
<span class="co">#&gt; rate[1,14]      0.00    0.00 0.00   0.00   0.00   0.00   0.00   0.00  5964    1</span>
<span class="co">#&gt; rate[1,15]      0.00    0.00 0.00   0.00   0.00   0.00   0.00   0.00  6855    1</span>
<span class="co">#&gt; rate[1,16]      0.00    0.00 0.00   0.00   0.00   0.00   0.00   0.00  5928    1</span>
<span class="co">#&gt; rate[1,17]      0.00    0.00 0.00   0.00   0.00   0.00   0.00   0.00  7180    1</span>
<span class="co">#&gt; rate[1,18]      0.00    0.00 0.00   0.00   0.00   0.00   0.00   0.00  5482    1</span>
<span class="co">#&gt; rate[1,19]      0.00    0.00 0.00   0.00   0.00   0.00   0.00   0.00  6860    1</span>
<span class="co">#&gt; sigma[1]        0.03    0.00 0.01   0.01   0.02   0.02   0.03   0.04  1825    1</span>
<span class="co">#&gt; log_lik[1,1]   -5.26    0.01 0.59  -6.92  -5.41  -5.03  -4.87  -4.82  3664    1</span>
<span class="co">#&gt; log_lik[1,2]   -5.26    0.01 0.55  -6.80  -5.42  -5.05  -4.89  -4.84  4449    1</span>
<span class="co">#&gt; log_lik[1,3]   -5.86    0.01 0.96  -8.32  -6.30  -5.59  -5.12  -4.88  5220    1</span>
<span class="co">#&gt; log_lik[1,4]   -5.25    0.01 0.51  -6.70  -5.40  -5.06  -4.91  -4.87  4109    1</span>
<span class="co">#&gt; log_lik[1,5]   -5.25    0.01 0.50  -6.67  -5.38  -5.06  -4.92  -4.88  4049    1</span>
<span class="co">#&gt; log_lik[1,6]   -5.45    0.01 0.68  -7.33  -5.67  -5.20  -4.98  -4.90  5076    1</span>
<span class="co">#&gt; log_lik[1,7]   -5.31    0.01 0.56  -6.83  -5.46  -5.10  -4.93  -4.88  4729    1</span>
<span class="co">#&gt; log_lik[1,8]   -5.31    0.01 0.57  -6.94  -5.47  -5.10  -4.94  -4.90  3984    1</span>
<span class="co">#&gt; log_lik[1,9]   -5.20    0.01 0.44  -6.46  -5.31  -5.03  -4.92  -4.88  3855    1</span>
<span class="co">#&gt; log_lik[1,10]  -5.20    0.01 0.45  -6.47  -5.30  -5.03  -4.92  -4.88  3181    1</span>
<span class="co">#&gt; log_lik[1,11]  -5.19    0.01 0.43  -6.40  -5.27  -5.03  -4.92  -4.89  3281    1</span>
<span class="co">#&gt; log_lik[1,12]  -5.30    0.01 0.54  -6.85  -5.44  -5.10  -4.95  -4.91  3762    1</span>
<span class="co">#&gt; log_lik[1,13]  -5.20    0.01 0.42  -6.39  -5.29  -5.04  -4.94  -4.91  3103    1</span>
<span class="co">#&gt; log_lik[1,14]  -5.22    0.01 0.43  -6.46  -5.32  -5.06  -4.95  -4.92  3519    1</span>
<span class="co">#&gt; log_lik[1,15]  -5.22    0.01 0.42  -6.40  -5.31  -5.05  -4.96  -4.93  3078    1</span>
<span class="co">#&gt; log_lik[1,16]  -5.40    0.01 0.57  -6.98  -5.58  -5.19  -5.00  -4.95  3895    1</span>
<span class="co">#&gt; log_lik[1,17]  -5.23    0.01 0.40  -6.36  -5.33  -5.08  -4.98  -4.95  3503    1</span>
<span class="co">#&gt; log_lik[1,18]  -5.79    0.01 0.90  -8.24  -6.18  -5.52  -5.12  -4.96  4960    1</span>
<span class="co">#&gt; log_lik[1,19]  -5.49    0.01 0.71  -7.49  -5.70  -5.22  -5.01  -4.94  3535    1</span>
<span class="co">#&gt; lp__          -25.44    0.10 3.88 -33.94 -27.87 -25.03 -22.65 -18.96  1562    1</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Samples were drawn using NUTS(diag_e) at Fri Jul 29 18:25:03 2022.</span>
<span class="co">#&gt; For each parameter, n_eff is a crude measure of effective sample size,</span>
<span class="co">#&gt; and Rhat is the potential scale reduction factor on split chains (at </span>
<span class="co">#&gt; convergence, Rhat=1).</span></code></pre></div>
<p><code>sigma</code> is the scale parameter for the model; the <code>log_lik</code> parameters are the log-likelihood of each observation. This is used for calculating WAIC (see <code><a href="../reference/waic.html">?surveil::waic</a></code>). The <code>lp__</code> parameter is always generated by Stan, it is the log-probability of the model.</p>
<p>If Stan is warning that Bulk ESS or tail area ESS is low and possibly unreliable, the first thing you can do is print results and inspect the ESS values. Depending on one’s purpose, the warning may be overly cautious. The next step is usually to increase the number of samples drawn (using the <code>iter</code> argument to <code>stan_rw</code>).</p>
</div>
<div class="section level2">
<h2 id="rhat">Rhat<a class="anchor" aria-label="anchor" href="#rhat"></a>
</h2>
<p>A second important difference between sampling with MCMC and sampling with functions like <code>rnorm</code> is that with MCMC we have to <em>find</em> the target distribution. The reason <strong>rstan</strong> (and <strong>surveil</strong>) samples from multiple, independent MCMC chains by default is that this allows us to check that they have all converged on the same distribution. If one or more chains does not resemble the others, then there is obviously a convergence failure.</p>
<p>To make the most of the information provided by these MCMC chains, we can split each of them in half, effectively doubling the number of chains, before checking convergence. This is known as the split Rhat statistic <span class="citation">(Gelman et al. <a href="#ref-gelman_2014">2014</a>)</span>. When chains have converged, the Rhat statistics will all equal 1.</p>
<p>The Rhat statistic can be examined by printing the Stanfit object <code>print(fit$samples)</code>. Since we always have at least as many parameters as we do time periods, it helps to visualize them all at once using <code><a href="https://mc-stan.org/rstan/reference/stan_plot_diagnostics.html" class="external-link">rstan::stan_rhat</a></code>:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stan_plot_diagnostics.html" class="external-link">stan_rhat</a></span><span class="op">(</span><span class="va">samples</span><span class="op">)</span>
<span class="co">#&gt; `stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</span></code></pre></div>
<p><img src="surveil-mcmc_files/figure-html/unnamed-chunk-15-1.png" width="384" style="display: block; margin: auto;"></p>
<p>These are all very near to 1. If any were approaching 1.05 or larger, we would want to run the chains for longer and then check results again.</p>
</div>
<div class="section level2">
<h2 id="divergent-transitions">Divergent transitions<a class="anchor" aria-label="anchor" href="#divergent-transitions"></a>
</h2>
<p>Sometimes, MCMC algorithms are unable to provide unbiased samples that will converge on the target distribution given sufficient time. Stan’s MCMC algorithm will issue a warning when it encounters a region of the probability model that it is unable to explore. These warnings of “divergent transitions” should not be ignored, as they indicate that something may have gone wrong <span class="citation">(Betancourt <a href="#ref-betancourt_2017b">2017</a><a href="#ref-betancourt_2017b">a</a>, <a href="#ref-betancourt_2017">2017</a><a href="#ref-betancourt_2017">b</a>)</span>. They will be printed to the console just after the model finishes sampling. Note that other MCMC platforms are simply unable to identify this bias (they will not issue a warning like Stan’s divergent transitions, even if the problem is present).</p>
<p>If you receive a divergent transition warning from a <strong>surveil</strong> model, here are some things to consider:</p>
<ol style="list-style-type: decimal">
<li><p>Draw more samples: if you also have low ESS, the divergent transitions may disappear by increasing the number of iterations (lengthening Stan’s adaptation or warm-up period). However, the default value of <code>iter = 3000</code> should generally be sufficient.</p></li>
<li><p>Raise <code>adapt_delta</code>: you can also control a tuning parameter related to divergent transitions. Simply raising the <code>adapt_delta</code> value to, say, 0.99 or 0.999 if need be, may be sufficient; e.g., <code>stan_rw(data, time = Year, control = list(adapt_delta = 0.99, max_treedepth = 13))</code>. (When raising <code>adapt_delta</code>, raising <code>max_treedepth</code> may improve sampling speed.) Raising <code>adapt_delta</code> ever closer to 1 (e.g., to .9999) is generally not helpful.</p></li>
</ol>
<p>There may be times when you are not able to prevent divergent transitions. This may occur when the population at risk is small and observations are particularly noisy; introducing the covariance structure (using <code>core = TRUE</code>) may make these issues more difficult to address. If there is a large number of divergent transitions, this is a serious warning. You may have made a mistake with your input data, or it could be that the model is just not very appropriate for the data.</p>
<p>If the number of divergent transitions is small (e.g., a handful out of 6,000 samples), you may determine that the amount of bias potentially introduced is acceptable for your purposes. You may want to report the issue along with results.</p>
</div>
<div class="section level2 unnumbered">
<h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references">
<div id="ref-betancourt_2017b">
<p>Betancourt, Michael. 2017a. “A Conceptual Introduction to Hamiltonian Monte Carlo.” <em>arXiv Preprint arXiv:1701.02434</em>.</p>
</div>
<div id="ref-betancourt_2017">
<p>———. 2017b. “Diagnosing Biased Inference with Divergences.” <em>Stan Case Studies</em> 4. <a href="https://mc-stan.org/users/documentation/case-studies/divergences_and_bias.html" class="external-link">https://mc-stan.org/users/documentation/case-studies/divergences_and_bias.html</a>.</p>
</div>
<div id="ref-gelman_2014">
<p>Gelman, Andrew, John B Carlin, Hal S Stern, David B Dunson, Aki Vehtari, and Donald B Rubin. 2014. <em>Bayesian Data Analysis</em>. Third. CRC Press.</p>
</div>
<div id="ref-mackay_2003">
<p>MacKay, David M. 2003. <em>Information Theory, Inference, and Learning Algorithms</em>. Cambridge University Press.</p>
</div>
<div id="ref-vehtari_2021">
<p>Vehtari, Aki, Andrew Gelman, Daniel Simpson, Bob Carpenter, and Paul-Christian Bürkner. 2021. “Rank-Normalization, Folding, and Localization: An Improved R for Assessing Convergence of MCMC (with Discussion).” <em>Bayesian Analysis</em> 16 (2): 667–718.</p>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Connor Donegan.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.1.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
