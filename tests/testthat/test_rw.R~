
library(tidyverse)

iter = 50
data(msa)

dfw <- dplyr::filter(msa,
                     str_detect(MSA, "Dallas")          
                         )

context("stan_rw")
test_that("The two model types work, in stan_rw", {    
    fit <- stan_rw(
        data = filter(dfw, Race == "Hispanic"),
        time = Year,
        iter = iter,
        chains = 1
    )
    fit2 <- stan_rw(
        dfw,
        type = "RWCorr",
        group = Race,
        time = Year,
        iter = iter,
        chains = 1
    )
    ## fit3 <- stan_rw(
    ##     data = filter(dfw, Race == "Hispanic"),
    ##     type = "IMA",
    ##     iter = iter,
    ##     chains = 1
    ##     )
    expect_s3_class(fit, "surveil")
    expect_s3_class(fit2, "surveil")
#    expect_s3_class(fit3, "surveil")
})

test_that("loo methods work", {
        fit <- stan_rw(
            data = filter(dfw, Race == "Hispanic"),
            time = Year,
            iter = iter,
            chains = 1
        )
       IC <- loo(fit)
        expect_s3_class(IC, "psis_loo")
       IC2 <- waic(fit)
        expect_s3_class(IC2, "waic")        
})

test_that("group_diff works", {
    fit2 <- stan_rw(        
        dfw,
        group = Race,
        time = Year,
        type = "RW",
        iter = iter,
        chains = 1
        )
        x <- group_diff(fit2, "Black", "White")
        expect_s3_class(x, "list")
    })
